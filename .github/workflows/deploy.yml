name: deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout repo with full history (fix shallow clone error)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ Install Heroku CLI
      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      # ✅ Deploy to Heroku using Git push
      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
          HEROKU_APP_NAME: students-performance-app
        run: |
          echo "machine api.heroku.com login $HEROKU_EMAIL password $HEROKU_API_KEY" > ~/.netrc
          echo "machine git.heroku.com login $HEROKU_EMAIL password $HEROKU_API_KEY" >> ~/.netrc

          git config --global user.email "$HEROKU_EMAIL"
          git config --global user.name "GitHub Actions"

          git remote remove heroku || true
          git remote add heroku https://git.heroku.com/$HEROKU_APP_NAME.git

          git push heroku HEAD:main --force
